<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - BD Olympiad</title>
    <link href="/dist/output.css" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <header class="bg-white shadow">
        <nav class="container mx-auto px-6 py-3">
            <div class="flex justify-between items-center">
                <div class="text-2xl font-bold text-gray-800">BD Olympiad</div>
                
                <!-- Mobile menu button -->
                <div class="md:hidden">
                    <button id="mobile-menu-button" class="text-gray-800 hover:text-blue-500">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>

                <!-- Desktop navigation -->
                <div class="hidden md:flex space-x-6">
                    <a href="/index.html" class="text-gray-800 hover:text-blue-500">Home</a>
                    <a href="/olympiads.html" class="text-gray-800 hover:text-blue-500">Olympiads</a>
                    <a href="/leaderboard.html" class="text-gray-800 hover:text-blue-500">Leaderboard</a>
                    <a href="/profile.html" class="text-blue-500 font-bold hover:text-blue-700">Profile</a>
                    <a href="/login.html" class="text-gray-800 hover:text-blue-500">Login</a>
                    <a href="/register.html" class="text-gray-800 hover:text-blue-500">Register</a>
                </div>
            </div>

            <!-- Mobile navigation -->
            <div id="mobile-menu" class="hidden md:hidden mt-4">
                <div class="flex flex-col space-y-2">
                    <a href="/index.html" class="text-gray-800 hover:text-blue-500">Home</a>
                    <a href="/olympiads.html" class="text-gray-800 hover:text-blue-500">Olympiads</a>
                    <a href="/leaderboard.html" class="text-gray-800 hover:text-blue-500">Leaderboard</a>
                    <a href="/profile.html" class="text-blue-500 font-bold hover:text-blue-700">Profile</a>
                    <a href="/login.html" class="text-gray-800 hover:text-blue-500">Login</a>
                    <a href="/register.html" class="text-gray-800 hover:text-blue-500">Register</a>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mx-auto px-6 py-8">
        <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <!-- Profile header -->
                <div class="bg-blue-600 text-white p-6">
                    <div class="flex flex-col md:flex-row items-center">
                        <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center text-blue-600 text-3xl font-bold mb-4 md:mb-0 md:mr-6">
                            <span id="profile-initials">JS</span>
                        </div>
                        <div>
                            <h1 id="profile-name" class="text-2xl font-bold">John Smith</h1>
                            <p id="profile-school" class="text-blue-200">Dhaka International School</p>
                            <p id="profile-grade" class="text-blue-200">Grade 10</p>
                        </div>
                    </div>
                </div>
                
                <!-- Profile tabs -->
                <div class="bg-gray-100 px-6 py-4">
                    <div class="flex border-b">
                        <button id="tab-overview" class="px-4 py-2 text-blue-600 border-b-2 border-blue-600 font-medium">Overview</button>
                        <button id="tab-competitions" class="px-4 py-2 text-gray-600 font-medium">My Competitions</button>
                        <button id="tab-settings" class="px-4 py-2 text-gray-600 font-medium">Settings</button>
                    </div>
                </div>
                
                <!-- Tab content -->
                <div class="p-6">
                    <!-- Overview tab -->
                    <div id="content-overview" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h3 class="text-lg font-medium text-blue-800 mb-2">Upcoming Competitions</h3>
                                <div id="upcoming-competitions" class="space-y-3">
                                    <p class="text-gray-500">No upcoming competitions</p>
                                </div>
                            </div>
                            
                            <div class="bg-green-50 p-4 rounded-lg">
                                <h3 class="text-lg font-medium text-green-800 mb-2">Recent Results</h3>
                                <div id="recent-results" class="space-y-3">
                                    <p class="text-gray-500">No recent results</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h3 class="text-lg font-medium text-purple-800 mb-2">Achievements</h3>
                            <div id="achievements" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <p class="text-gray-500 col-span-4">No achievements yet</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Competitions tab -->
                    <div id="content-competitions" class="hidden space-y-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-medium">Registered Competitions</h3>
                            <a href="/olympiads.html" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Browse Competitions</a>
                        </div>
                        
                        <div id="registered-competitions" class="space-y-4">
                            <p class="text-gray-500">You haven't registered for any competitions yet.</p>
                        </div>
                        
                        <h3 class="text-lg font-medium mt-8">Completed Competitions</h3>
                        <div id="completed-competitions" class="space-y-4">
                            <p class="text-gray-500">You haven't completed any competitions yet.</p>
                        </div>
                    </div>
                    
                    <!-- Settings tab -->
                    <div id="content-settings" class="hidden">
                        <form id="profile-form" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="fullName" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                                    <input type="text" id="fullName" name="fullName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                
                                <div>
                                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                    <input type="text" id="username" name="username" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                                </div>
                                
                                <div>
                                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                    <input type="email" id="email" name="email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                                </div>
                                
                                <div>
                                    <label for="school" class="block text-sm font-medium text-gray-700 mb-1">School</label>
                                    <input type="text" id="school" name="school" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                
                                <div>
                                    <label for="grade" class="block text-sm font-medium text-gray-700 mb-1">Grade/Class</label>
                                    <select id="grade" name="grade" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="6">Grade 6</option>
                                        <option value="7">Grade 7</option>
                                        <option value="8">Grade 8</option>
                                        <option value="9">Grade 9</option>
                                        <option value="10">Grade 10</option>
                                        <option value="11">Grade 11</option>
                                        <option value="12">Grade 12</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <h3 class="text-lg font-medium mb-3">Change Password</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="currentPassword" class="block text-sm font-medium text-gray-700 mb-1">Current Password</label>
                                        <input type="password" id="currentPassword" name="currentPassword" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    
                                    <div>
                                        <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-1">New Password</label>
                                        <input type="password" id="newPassword" name="newPassword" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-between">
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded">
                                    Save Changes
                                </button>
                                
                                <button id="logout-button" type="button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded">
                                    Logout
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-8 mt-12">
        <div class="container mx-auto px-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div>
                    <h3 class="text-xl font-bold mb-4">BD Olympiad</h3>
                    <p class="text-gray-300">The ultimate platform for Bangladeshi students to showcase their skills in academic competitions.</p>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Quick Links</h3>
                    <ul class="space-y-2">
                        <li><a href="/index.html" class="text-gray-300 hover:text-white">Home</a></li>
                        <li><a href="/olympiads.html" class="text-gray-300 hover:text-white">Olympiads</a></li>
                        <li><a href="/leaderboard.html" class="text-gray-300 hover:text-white">Leaderboard</a></li>
                        <li><a href="/profile.html" class="text-gray-300 hover:text-white">Profile</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Admin Access</h3>
                    <p class="text-gray-300 mb-4">Website administrators can access the control panel below:</p>
                    <a href="/admin/" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded inline-block">
                        Admin Login
                    </a>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-6 text-center text-gray-300">
                &copy; 2024 BD Olympiad. All rights reserved.
            </div>
        </div>
    </footer>

    <script src="/js/script.js"></script>
    <script src="/js/supabase-config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Check if user is logged in
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = '/login.html';
                return;
            }
            
            try {
                // Get user profile from Supabase
                const { data: user, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', session.user.id)
                    .single();
                
                if (error) throw error;
                
                if (!user) {
                    console.error('User profile not found');
                    localStorage.removeItem('supabase.auth.token');
                    window.location.href = '/login.html';
                    return;
                }
                
                // Set profile information
                document.getElementById('profile-name').textContent = user.full_name;
                document.getElementById('profile-school').textContent = user.school;
                document.getElementById('profile-grade').textContent = `Grade ${user.grade}`;
                
                // Set profile initials
                const nameParts = user.full_name.split(' ');
                let initials = '';
                if (nameParts.length >= 2) {
                    initials = nameParts[0][0] + nameParts[1][0];
                } else if (nameParts.length === 1) {
                    initials = nameParts[0][0];
                }
                document.getElementById('profile-initials').textContent = initials.toUpperCase();
                
                // Fill form fields
                document.getElementById('fullName').value = user.full_name;
                document.getElementById('username').value = user.username;
                document.getElementById('email').value = user.email;
                document.getElementById('school').value = user.school;
                document.getElementById('grade').value = user.grade;
                
                // Tab switching
                const tabs = ['overview', 'competitions', 'settings'];
                tabs.forEach(tab => {
                    document.getElementById(`tab-${tab}`).addEventListener('click', function() {
                        // Hide all content
                        tabs.forEach(t => {
                            document.getElementById(`content-${t}`).classList.add('hidden');
                            document.getElementById(`tab-${t}`).classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                            document.getElementById(`tab-${t}`).classList.add('text-gray-600');
                        });
                        
                        // Show selected content
                        document.getElementById(`content-${tab}`).classList.remove('hidden');
                        document.getElementById(`tab-${tab}`).classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                        document.getElementById(`tab-${tab}`).classList.remove('text-gray-600');
                    });
                });
                
                // Fetch user competitions from Supabase
                const { data: registrations, error: regError } = await supabaseClient
                    .from('registrations')
                    .select(`
                        id,
                        status,
                        registration_date,
                        competitions (
                            id,
                            title,
                            description,
                            category,
                            start_date,
                            end_date,
                            duration
                        ),
                        submissions (
                            id,
                            start_time,
                            end_time,
                            score
                        )
                    `)
                    .eq('user_id', session.user.id);
                
                if (regError) throw regError;
                
                // Process competitions data
                if (registrations && registrations.length > 0) {
                    const now = new Date();
                    
                    // Upcoming competitions (registered but not started or completed)
                    const upcoming = registrations.filter(reg => 
                        reg.status === 'registered' && 
                        new Date(reg.competitions.start_date) > now && 
                        (!reg.submissions || reg.submissions.length === 0)
                    );
                    
                    if (upcoming.length > 0) {
                        const upcomingContainer = document.getElementById('upcoming-competitions');
                        upcomingContainer.innerHTML = '';
                        
                        upcoming.forEach(reg => {
                            const comp = reg.competitions;
                            const compElement = document.createElement('div');
                            compElement.className = 'bg-white p-3 rounded shadow-sm';
                            compElement.innerHTML = `
                                <h4 class="font-medium">${comp.title}</h4>
                                <p class="text-sm text-gray-600">${new Date(comp.start_date).toLocaleDateString()}</p>
                                <a href="/exam.html?id=${comp.id}" class="text-blue-600 text-sm hover:underline">Take Exam</a>
                            `;
                            upcomingContainer.appendChild(compElement);
                        });
                    }
                    
                    // Completed competitions
                    const completed = registrations.filter(reg => 
                        reg.status === 'completed' && 
                        reg.submissions && 
                        reg.submissions.length > 0
                    );
                    
                    if (completed.length > 0) {
                        const resultsContainer = document.getElementById('recent-results');
                        resultsContainer.innerHTML = '';
                        
                        const completedContainer = document.getElementById('completed-competitions');
                        completedContainer.innerHTML = '';
                        
                        completed.forEach(reg => {
                            const comp = reg.competitions;
                            const submission = reg.submissions[0];
                            
                            // For recent results
                            const resultElement = document.createElement('div');
                            resultElement.className = 'bg-white p-3 rounded shadow-sm';
                            resultElement.innerHTML = `
                                <h4 class="font-medium">${comp.title}</h4>
                                <p class="text-sm text-gray-600">Score: ${submission.score}</p>
                            `;
                            resultsContainer.appendChild(resultElement);
                            
                            // For completed competitions
                            const compElement = document.createElement('div');
                            compElement.className = 'bg-white p-4 rounded shadow border-l-4 border-green-500';
                            compElement.innerHTML = `
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h4 class="font-medium text-lg">${comp.title}</h4>
                                        <p class="text-gray-600">${comp.category}</p>
                                        <p class="text-sm text-gray-500">Completed on ${new Date(submission.end_time).toLocaleDateString()}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-medium">Score: ${submission.score}</p>
                                    </div>
                                </div>
                            `;
                            completedContainer.appendChild(compElement);
                        });
                    }
                    
                    // Registered competitions (not yet completed)
                    const registered = registrations.filter(reg => 
                        reg.status === 'registered' && 
                        (!reg.submissions || reg.submissions.length === 0)
                    );
                    
                    if (registered.length > 0) {
                        const registeredContainer = document.getElementById('registered-competitions');
                        registeredContainer.innerHTML = '';
                        
                        registered.forEach(reg => {
                            const comp = reg.competitions;
                            const compElement = document.createElement('div');
                            compElement.className = 'bg-white p-4 rounded shadow border-l-4 border-blue-500';
                            compElement.innerHTML = `
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h4 class="font-medium text-lg">${comp.title}</h4>
                                        <p class="text-gray-600">${comp.category}</p>
                                        <p class="text-sm text-gray-500">
                                            ${new Date(comp.start_date).toLocaleDateString()} - 
                                            ${new Date(comp.end_date).toLocaleDateString()}
                                        </p>
                                    </div>
                                    <a href="/exam.html?id=${comp.id}" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                                        Take Exam
                                    </a>
                                </div>
                            `;
                            registeredContainer.appendChild(compElement);
                        });
                    }
                }
                
                // Profile form submission
                const profileForm = document.getElementById('profile-form');
                profileForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const fullName = document.getElementById('fullName').value;
                    const school = document.getElementById('school').value;
                    const grade = document.getElementById('grade').value;
                    const currentPassword = document.getElementById('currentPassword').value;
                    const newPassword = document.getElementById('newPassword').value;
                    
                    try {
                        // Update profile in Supabase
                        const { error: updateError } = await supabase
                            .from('profiles')
                            .update({
                                full_name: fullName,
                                school: school,
                                grade: grade,
                                updated_at: new Date()
                            })
                            .eq('id', session.user.id);
                        
                        if (updateError) throw updateError;
                        
                        // Update password if provided
                        if (currentPassword && newPassword) {
                            const { error: passwordError } = await supabase.auth.updateUser({
                                password: newPassword
                            });
                            
                            if (passwordError) throw passwordError;
                        }
                        
                        // Update profile display
                        document.getElementById('profile-name').textContent = fullName;
                        document.getElementById('profile-school').textContent = school;
                        document.getElementById('profile-grade').textContent = `Grade ${grade}`;
                        
                        // Update initials
                        const nameParts = fullName.split(' ');
                        let initials = '';
                        if (nameParts.length >= 2) {
                            initials = nameParts[0][0] + nameParts[1][0];
                        } else if (nameParts.length === 1) {
                            initials = nameParts[0][0];
                        }
                        document.getElementById('profile-initials').textContent = initials.toUpperCase();
                        
                        // Clear password fields
                        document.getElementById('currentPassword').value = '';
                        document.getElementById('newPassword').value = '';
                        
                        alert('Profile updated successfully!');
                    } catch (error) {
                        console.error('Update error:', error);
                        alert('Failed to update profile: ' + error.message);
                    }
                });
                
                // Logout button
                document.getElementById('logout-button').addEventListener('click', async function() {
                    try {
                        await supabase.auth.signOut();
                        localStorage.removeItem('supabase.auth.token');
                        localStorage.removeItem('currentUser');
                        window.location.href = '/index.html';
                    } catch (error) {
                        console.error('Logout error:', error);
                        // Force logout even if API call fails
                        localStorage.removeItem('supabase.auth.token');
                        localStorage.removeItem('currentUser');
                        window.location.href = '/index.html';
                    }
                });
            } catch (error) {
                console.error('Error loading profile:', error);
                alert('Error loading profile: ' + error.message);
            }
        });
    </script>
</body>
</html>